# Gatekeeper Test: GPU Node Usage
# Run: kubectl apply -f test-gpu-nodes.yaml --dry-run=server
---
# PASS: Properly configured GPU pod
apiVersion: v1
kind: Pod
metadata:
  name: test-gpu-valid
  namespace: default
spec:
  nodeSelector:
    node-type: gpu
    gpu-type: nvidia
  tolerations:
  - key: nvidia.com/gpu
    operator: Equal
    value: present
    effect: NoSchedule
  containers:
  - name: gpu-app
    image: tensorflow/tensorflow:latest-gpu
    resources:
      limits:
        nvidia.com/gpu: 2
      requests:
        nvidia.com/gpu: 2
---
# FAIL: GPU request without node selector (should be blocked)
apiVersion: v1
kind: Pod
metadata:
  name: test-gpu-no-selector
  namespace: default
spec:
  containers:
  - name: app
    image: myapp:v1
    resources:
      limits:
        nvidia.com/gpu: 1
      requests:
        nvidia.com/gpu: 1
---
# FAIL: Mismatched GPU limits and requests (should be blocked)
apiVersion: v1
kind: Pod
metadata:
  name: test-gpu-mismatch
  namespace: default
spec:
  nodeSelector:
    node-type: gpu
    gpu-type: nvidia
  tolerations:
  - key: nvidia.com/gpu
    operator: Equal
    value: present
    effect: NoSchedule
  containers:
  - name: app
    image: myapp:v1
    resources:
      limits:
        nvidia.com/gpu: 2
      requests:
        nvidia.com/gpu: 1
---
# FAIL: Missing toleration (should be blocked)
apiVersion: v1
kind: Pod
metadata:
  name: test-gpu-no-toleration
  namespace: default
spec:
  nodeSelector:
    node-type: gpu
    gpu-type: nvidia
  containers:
  - name: app
    image: myapp:v1
    resources:
      limits:
        nvidia.com/gpu: 1
      requests:
        nvidia.com/gpu: 1
